<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Peer-to-Peer File Sharing</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: Arial, sans-serif;
      margin-top: 50px;
    }
    input, button {
      margin: 10px;
      padding: 10px;
    }
    a {
      margin-top: 20px;
      text-decoration: none;
      color: blue;
    }
    #status {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Peer-to-Peer File Sharing (No Account Required)</h1>
  <input type="file" id="fileInput" />
  <button id="shareButton">Share File</button>
  <a id="downloadLink" style="display:none">Download File</a>
  <p id="status"></p>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database-compat.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: 'YOUR_API_KEY',
      authDomain: 'YOUR_AUTH_DOMAIN',
      databaseURL: 'YOUR_DATABASE_URL',
      projectId: 'YOUR_PROJECT_ID',
      storageBucket: 'YOUR_STORAGE_BUCKET',
      messagingSenderId: 'YOUR_MESSAGING_SENDER_ID',
      appId: 'YOUR_APP_ID'
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const peerConnection = new RTCPeerConnection();
    let dataChannel;
    let receiveChannel;
    const fileInput = document.getElementById('fileInput');
    const downloadLink = document.getElementById('downloadLink');
    const status = document.getElementById('status');
    const shareButton = document.getElementById('shareButton');
    const sessionId = Math.random().toString(36).substring(2);

    async function createOffer() {
      status.textContent = "Creating offer...";
      dataChannel = peerConnection.createDataChannel('file');

      // File sending logic
      dataChannel.onopen = () => {
        status.textContent = "Connection open, sending file...";
        const file = fileInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.readAsArrayBuffer(file);
          reader.onload = () => {
            dataChannel.send(reader.result);
            status.textContent = 'File sent!';
          };
        } else {
          status.textContent = 'No file selected!';
        }
      };

      dataChannel.onclose = () => status.textContent = 'Connection closed!';

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);

      // Save the offer in Firebase
      await db.ref(`sessions/${sessionId}`).set({ offer: JSON.stringify(offer) });
      status.textContent = `Share this link: ${window.location.href}?sessionId=${sessionId}`;
    }

    async function joinSession(sessionId) {
      status.textContent = "Joining session...";
      const sessionRef = db.ref(`sessions/${sessionId}`);
      const sessionData = await sessionRef.get();

      if (sessionData.exists()) {
        const offer = JSON.parse(sessionData.val().offer);
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);

        // Store the answer in Firebase
        await sessionRef.child('answer').set(JSON.stringify(answer));

        peerConnection.ondatachannel = (event) => {
          receiveChannel = event.channel;
          status.textContent = 'Connection established, waiting for file...';

          const receivedChunks = [];
          receiveChannel.onmessage = (event) => {
            receivedChunks.push(event.data);
            const blob = new Blob(receivedChunks);
            downloadLink.href = URL.createObjectURL(blob);
            downloadLink.download = 'received_file';
            downloadLink.style.display = 'block';
            status.textContent = 'File received!';
          };

          receiveChannel.onclose = () => status.textContent = 'Connection closed!';
        };
      } else {
        status.textContent = 'Session not found!';
      }
    }

    peerConnection.onicecandidate = (event) => {
      if (event.candidate) {
        db.ref(`sessions/${sessionId}/candidates`).push(JSON.stringify(event.candidate));
      }
    };

    async function handleNewICECandidate(sessionId) {
      const candidatesRef = db.ref(`sessions/${sessionId}/candidates`);
      candidatesRef.on('child_added', async (snapshot) => {
        const candidate = JSON.parse(snapshot.val());
        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
      });
    }

    // Check if joining an existing session
    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const sessionId = urlParams.get('sessionId');

      if (sessionId) {
        await joinSession(sessionId);
        await handleNewICECandidate(sessionId);
      } else {
        shareButton.addEventListener('click', async () => {
          await createOffer();
          await handleNewICECandidate(sessionId);
        });
      }
    });
  </script>
</body>
</html>
