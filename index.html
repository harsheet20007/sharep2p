<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Peer-to-Peer File Sharing</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: Arial, sans-serif;
      margin-top: 50px;
    }
    input, button {
      margin: 10px;
      padding: 10px;
    }
    a {
      margin-top: 20px;
      text-decoration: none;
      color: blue;
    }
    #status {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Peer-to-Peer File Sharing</h1>
  <input type="file" id="fileInput" />
  <button id="shareButton">Share File</button>
  <a id="downloadLink" style="display:none">Download File</a>
  <p id="status">Status: Waiting...</p>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database-compat.js"></script>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
     apiKey: "AIzaSyCNyZAmw3D8aCqNOHOw0f3YKtZWNatauN8",
      authDomain: "hello-4105a.firebaseapp.com",
      databaseURL: "https://hello-4105a-default-rtdb.firebaseio.com",
      projectId: "hello-4105a",
      storageBucket: "hello-4105a.appspot.com",
      messagingSenderId: "978669199403",
      appId: "1:978669199403:web:6c20e3dbaf815bba890a6e",
      measurementId: "G-2TGPP3E88X",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const peerConnection = new RTCPeerConnection();
    const status = document.getElementById('status');
    const fileInput = document.getElementById('fileInput');
    const downloadLink = document.getElementById('downloadLink');
    const shareButton = document.getElementById('shareButton');

    let dataChannel;
    let receiveChannel;
    const sessionId = Math.random().toString(36).substring(2);

    async function createOffer() {
      status.textContent = "Creating offer...";
      dataChannel = peerConnection.createDataChannel('fileTransfer');

      // Set up data channel for sending file
      dataChannel.onopen = () => {
        const file = fileInput.files[0];
        if (file) {
          status.textContent = "Sending file...";
          const reader = new FileReader();
          reader.onload = () => {
            dataChannel.send(reader.result);
            status.textContent = "File sent!";
          };
          reader.readAsArrayBuffer(file);
        } else {
          status.textContent = "No file selected!";
        }
      };

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      await db.ref(`sessions/${sessionId}`).set({ offer: JSON.stringify(offer) });

      status.textContent = `Share this link: ${window.location.href}?sessionId=${sessionId}`;
    }

    async function joinSession(sessionId) {
      status.textContent = "Joining session...";
      const sessionRef = db.ref(`sessions/${sessionId}`);
      const sessionData = await sessionRef.get();

      if (sessionData.exists()) {
        const offer = JSON.parse(sessionData.val().offer);
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        await sessionRef.child('answer').set(JSON.stringify(answer));

        peerConnection.ondatachannel = (event) => {
          receiveChannel = event.channel;
          status.textContent = "Connected! Receiving file...";

          const receivedChunks = [];
          receiveChannel.onmessage = (event) => {
            receivedChunks.push(event.data);
            const blob = new Blob(receivedChunks);
            downloadLink.href = URL.createObjectURL(blob);
            downloadLink.download = 'received_file';
            downloadLink.style.display = 'block';
            status.textContent = "File received!";
          };
        };
      } else {
        status.textContent = "Invalid session!";
      }
    }

    peerConnection.onicecandidate = (event) => {
      if (event.candidate) {
        db.ref(`sessions/${sessionId}/candidates`).push(JSON.stringify(event.candidate));
      }
    };

    async function handleICECandidates(sessionId) {
      const candidatesRef = db.ref(`sessions/${sessionId}/candidates`);
      candidatesRef.on('child_added', async (snapshot) => {
        const candidate = JSON.parse(snapshot.val());
        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const sessionId = urlParams.get('sessionId');

      if (sessionId) {
        await joinSession(sessionId);
        await handleICECandidates(sessionId);
      } else {
        shareButton.addEventListener('click', async () => {
          await createOffer();
          await handleICECandidates(sessionId);
        });
      }
    });
  </script>
</body>
</html>
